<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>MicroBlog Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .post-img { max-height: 350px; width: 100%; object-fit: cover; border-radius: 1rem; margin-top: 10px; }
        .repost-border { border-left: 4px solid #3b82f6; padding-left: 10px; margin-top: 10px; opacity: 0.8; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 transition-colors duration-300">

    <div class="max-w-6xl mx-auto flex justify-center gap-6">
        
        <main class="w-full max-w-2xl bg-white dark:bg-zinc-800 min-h-screen shadow-xl sm:border-x dark:border-zinc-700">
            
            <header class="p-4 border-b dark:border-zinc-700 sticky top-0 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-md z-40 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-black text-blue-500 italic tracking-tighter">M.</h1>
                    <button id="theme-toggle" class="text-xl">üåì</button>
                </div>
                <div id="auth-status" class="flex items-center gap-3">
                    <span id="user-display" class="text-xs font-bold opacity-60">–ì–æ—Å—Ç—å</span>
                    <button id="auth-btn" class="bg-blue-500 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-lg active:scale-95 transition">–í–æ–π—Ç–∏</button>
                </div>
            </header>

            <div class="p-4 border-b dark:border-zinc-700">
                <textarea id="post-text" class="w-full bg-transparent text-lg outline-none resize-none placeholder:text-zinc-500" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" rows="3"></textarea>
                
                <div id="preview-box" class="hidden relative mb-3">
                    <img id="img-preview" src="" class="rounded-2xl border dark:border-zinc-600 max-h-48">
                    <button onclick="clearImg()" class="absolute top-2 left-2 bg-black/50 text-white p-1 rounded-full">‚úï</button>
                </div>

                <div class="flex justify-between items-center border-t dark:border-zinc-700 pt-3">
                    <label class="cursor-pointer p-2 hover:bg-blue-50 dark:hover:bg-zinc-700 rounded-full transition text-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                    </label>
                    <button id="send-btn" class="bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-md disabled:opacity-50">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                </div>
            </div>

            <div id="feed" class="divide-y dark:divide-zinc-700"></div>
        </main>

        <aside class="w-72 hidden lg:block py-6">
            <div class="bg-white dark:bg-zinc-800 p-5 rounded-3xl shadow-sm border dark:border-zinc-700 sticky top-24">
                <h3 class="font-black text-sm uppercase tracking-widest mb-4 opacity-50">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <div id="rec-list" class="space-y-4"></div>
            </div>
        </aside>
    </div>

    <div id="profile-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[60] p-4 flex items-center justify-center">
        <div class="bg-white dark:bg-zinc-800 w-full max-w-xl rounded-3xl max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="p-6 border-b dark:border-zinc-700 flex justify-between items-center">
                <h2 id="prof-name" class="text-2xl font-black">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <button onclick="closeProfile()" class="text-2xl">‚úï</button>
            </div>
            <div id="prof-posts" class="divide-y dark:divide-zinc-700"></div>
        </div>
    </div>

    <div id="auth-modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-3xl shadow-2xl w-full max-w-xs text-center">
            <h2 class="text-2xl font-bold mb-6">–í–æ–π—Ç–∏ –≤ —Å–µ—Ç—å</h2>
            <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-3 rounded-xl bg-zinc-100 dark:bg-zinc-700 outline-none">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 mb-6 rounded-xl bg-zinc-100 dark:bg-zinc-700 outline-none">
            <button id="submit-auth" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button onclick="document.getElementById('auth-modal').classList.add('hidden')" class="mt-4 text-xs opacity-50">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í—Å—Ç–∞–≤—å —Å–≤–æ–∏ –∫–ª—é—á–∏!) ---
        const firebaseConfig = {
        apiKey: "AIzaSyALdLdIiC5Jwfkeo6gfa3OaHHm3gkQ3jtM",
        authDomain: "qiwi-8aa6a.firebaseapp.com",
        databaseURL: "https://qiwi-8aa6a-default-rtdb.firebaseio.com",
        projectId: "qiwi-8aa6a",
        storageBucket: "qiwi-8aa6a.firebasestorage.app",
        messagingSenderId: "1:12192651267:web:73e98c5c764a19e3d2d636",
        appId: "G-6HWP543LDE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null;
        let selectedImg = null;

        // --- –õ–û–ì–ò–ö–ê –¢–ï–ú–´ ---
        document.getElementById('theme-toggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
        };

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('user-display').innerText = user ? user.email.split('@')[0] : '–ì–æ—Å—Ç—å';
            document.getElementById('auth-btn').innerText = user ? '–í—ã–π—Ç–∏' : '–í–æ–π—Ç–∏';
            if(user) db.ref('users/' + user.uid).set({ email: user.email, handle: user.email.split('@')[0] });
        });

        document.getElementById('auth-btn').onclick = () => {
            if(currentUser) auth.signOut();
            else document.getElementById('auth-modal').classList.remove('hidden');
        };

        document.getElementById('submit-auth').onclick = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            try {
                await auth.signInWithEmailAndPassword(e, p);
            } catch {
                await auth.createUserWithEmailAndPassword(e, p);
            }
            document.getElementById('auth-modal').classList.add('hidden');
        };

        // --- –§–û–¢–û ---
        document.getElementById('file-input').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedImg = ev.target.result;
                document.getElementById('img-preview').src = selectedImg;
                document.getElementById('preview-box').classList.remove('hidden');
            };
            reader.readAsDataURL(e.target.files[0]);
        };
        window.clearImg = () => {
            selectedImg = null;
            document.getElementById('preview-box').classList.add('hidden');
        };

        // --- –ü–û–°–¢–´ (–õ–ê–ô–ö–ò, –ö–û–ú–ú–ï–ù–¢–´, –†–ï–ü–û–°–¢–´) ---
        document.getElementById('send-btn').onclick = () => {
            const text = document.getElementById('post-text').value.trim();
            if(!text && !selectedImg) return;
            if(!currentUser) return alert("–í–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç!");

            db.ref('posts').push({
                uid: currentUser.uid,
                author: currentUser.email.split('@')[0],
                content: text,
                image: selectedImg,
                date: Date.now(),
                likes: {},
                comments: []
            });
            document.getElementById('post-text').value = "";
            clearImg();
        };

        function renderPost(id, post, isFull = true) {
            const likeCount = post.likes ? Object.keys(post.likes).length : 0;
            const isLiked = post.likes && post.likes[currentUser?.uid];
            
            return `
                <div class="p-4 sm:p-6 post-card">
                    <div class="flex gap-3">
                        <div onclick="openProfile('${post.uid}')" class="w-10 h-10 bg-blue-500 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-white cursor-pointer">
                            ${post.author[0].toUpperCase()}
                        </div>
                        <div class="w-full">
                            <div class="flex justify-between">
                                <b onclick="openProfile('${post.uid}')" class="cursor-pointer hover:underline">@${post.author}</b>
                                <small class="opacity-40 text-[10px]">${new Date(post.date).toLocaleTimeString()}</small>
                            </div>
                            <p class="mt-1 text-[16px]">${post.content}</p>
                            ${post.image ? `<img src="${post.image}" class="post-img shadow-sm border dark:border-zinc-700">` : ''}
                            
                            ${post.repost ? `
                                <div class="repost-border">
                                    <small class="text-blue-500 font-bold">–†–µ–ø–æ—Å—Ç –æ—Ç @${post.repost.author}</small>
                                    <p class="text-sm italic">${post.repost.content}</p>
                                </div>
                            ` : ''}

                            <div class="flex gap-8 mt-4">
                                <button onclick="doLike('${id}')" class="flex items-center gap-1.5 transition ${isLiked ? 'text-red-500' : 'opacity-50 hover:text-red-500'}">
                                    <span>${isLiked ? '‚ù§Ô∏è' : '‚ô°'}</span> <span class="text-xs font-bold">${likeCount}</span>
                                </button>
                                <button onclick="toggleComments('${id}')" class="flex items-center gap-1.5 opacity-50 hover:text-blue-500 transition">
                                    <span>üí¨</span> <span class="text-xs font-bold">${post.comments ? Object.keys(post.comments).length : 0}</span>
                                </button>
                                <button onclick="doRepost('${id}')" class="opacity-50 hover:text-green-500 transition">üîÅ</button>
                            </div>

                            <div id="comm-${id}" class="hidden mt-4 pt-4 border-t dark:border-zinc-700">
                                <div class="space-y-2 mb-3">
                                    ${post.comments ? Object.values(post.comments).map(c => `<div class="text-xs bg-zinc-100 dark:bg-zinc-700/50 p-2 rounded-lg"><b>@${c.author}:</b> ${c.text}</div>`).join('') : ''}
                                </div>
                                <div class="flex gap-2">
                                    <input id="in-${id}" class="w-full bg-zinc-100 dark:bg-zinc-700 rounded-full px-4 py-1.5 text-xs outline-none" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç...">
                                    <button onclick="addComment('${id}')" class="text-blue-500 font-bold text-xs px-2">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        db.ref('posts').on('value', snap => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            if(snap.val()) {
                const arr = Object.entries(snap.val()).reverse();
                arr.forEach(([id, post]) => feed.innerHTML += renderPost(id, post));
            }
        });

        // --- –§–£–ù–ö–¶–ò–ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø ---
        window.doLike = (id) => {
            if(!currentUser) return alert("–í–æ–π–¥–∏!");
            const ref = db.ref(`posts/${id}/likes/${currentUser.uid}`);
            ref.once('value').then(s => s.exists() ? ref.remove() : ref.set(true));
        };

        window.toggleComments = (id) => document.getElementById(`comm-${id}`).classList.toggle('hidden');

        window.addComment = (id) => {
            const input = document.getElementById(`in-${id}`);
            if(!input.value.trim() || !currentUser) return;
            db.ref(`posts/${id}/comments`).push({
                author: currentUser.email.split('@')[0],
                text: input.value.trim()
            });
            input.value = "";
        };

        window.doRepost = (id) => {
            if(!currentUser) return alert("–í–æ–π–¥–∏!");
            db.ref(`posts/${id}`).once('value').then(snap => {
                const original = snap.val();
                db.ref('posts').push({
                    uid: currentUser.uid,
                    author: currentUser.email.split('@')[0],
                    content: "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —ç—Ç–æ!",
                    repost: original,
                    date: Date.now()
                });
            });
        };

        // --- –ü–†–û–§–ò–õ–¨ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ---
        window.openProfile = (uid) => {
            db.ref('posts').orderByChild('uid').equalTo(uid).once('value', snap => {
                const posts = snap.val();
                const container = document.getElementById('prof-posts');
                container.innerHTML = "";
                if(posts) {
                    Object.entries(posts).reverse().forEach(([id, post]) => container.innerHTML += renderPost(id, post));
                }
                document.getElementById('profile-modal').classList.remove('hidden');
            });
        };
        window.closeProfile = () => document.getElementById('profile-modal').classList.add('hidden');

        db.ref('users').limitToLast(5).on('value', snap => {
            const list = document.getElementById('rec-list');
            list.innerHTML = "";
            if(snap.val()) {
                Object.values(snap.val()).forEach(u => {
                    if(u.handle === currentUser?.email.split('@')[0]) return;
                    list.innerHTML += `
                        <div onclick="openProfile('${u.uid}')" class="flex items-center justify-between cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-700/30 p-2 rounded-xl transition">
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 bg-blue-500 rounded-full text-[10px] text-white flex items-center justify-center font-bold">${u.handle[0].toUpperCase()}</div>
                                <span class="text-sm font-bold">@${u.handle}</span>
                            </div>
                            <span class="text-[10px] text-blue-500 font-bold uppercase">–°–º–æ—Ç—Ä–µ—Ç—å</span>
                        </div>
                    `;
                });
            }
        });

    </script>
</body>
</html>
