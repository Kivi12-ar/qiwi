<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Engine Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        .active-nav { color: #3b82f6 !important; opacity: 1 !important; transform: scale(1.1); }
        .view-section { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .notif-dot { position: absolute; top: 0px; right: 0px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 2px solid white; display: none; }
        .dark .notif-dot { border-color: #09090b; }
        .repost-border { border-left: 3px solid #3b82f6; margin-left: 8px; padding-left: 12px; margin-top: 8px; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 font-sans">

    <header class="sticky top-0 z-40 bg-white/80 dark:bg-zinc-950/80 backdrop-blur-md border-b dark:border-zinc-800 p-4 flex justify-between items-center">
        <h1 class="text-xl font-black text-blue-500 italic tracking-tighter cursor-pointer" onclick="showView('feed')">SOCIAL.</h1>
        <div class="flex items-center gap-3">
            <span id="admin-badge" class="hidden bg-red-500 text-[9px] text-white px-2 py-0.5 rounded-full font-black uppercase">Admin</span>
            <button id="auth-btn" class="bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold">–í–æ–π—Ç–∏</button>
        </div>
    </header>

    <main class="max-w-2xl mx-auto">
        <section id="view-feed" class="view-section">
            <div id="post-input" class="p-4 border-b dark:border-zinc-900 hidden bg-white dark:bg-zinc-900/30">
                <textarea id="post-text" class="w-full bg-transparent text-lg outline-none resize-none" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" rows="2"></textarea>
                <div class="flex justify-between items-center mt-2">
                    <label class="p-2 text-blue-500 cursor-pointer">üñºÔ∏è <input type="file" id="file-input" class="hidden"></label>
                    <button id="send-btn" class="bg-blue-500 text-white px-6 py-2 rounded-full font-bold text-sm">–ü–æ—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
            <div id="feed-container" class="divide-y dark:divide-zinc-900"></div>
        </section>

        <section id="view-discovery" class="view-section hidden">
            <div class="p-4"><input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." class="w-full bg-zinc-100 dark:bg-zinc-900 p-4 rounded-2xl outline-none font-bold"></div>
            <div id="discovery-list" class="p-4 space-y-4"></div>
        </section>

        <section id="view-chats" class="view-section hidden">
            <h2 class="text-2xl font-black p-6 tracking-tight">–ß–∞—Ç—ã</h2>
            <div id="chats-list" class="divide-y dark:divide-zinc-900"></div>
        </section>

        <section id="view-chat-room" class="view-section hidden fixed inset-0 z-[60] bg-white dark:bg-zinc-950 flex flex-col">
            <div class="p-4 border-b dark:border-zinc-800 flex items-center gap-4 bg-white dark:bg-zinc-950">
                <button onclick="showView('chats')" class="text-2xl p-2">‚Üê</button>
                <img id="chat-target-av" src="" class="w-10 h-10 rounded-full object-cover">
                <b id="chat-target-nick" class="truncate">–ß–∞—Ç</b>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 flex flex-col no-scrollbar bg-slate-50 dark:bg-zinc-950"></div>
            <div class="p-4 border-t dark:border-zinc-800 flex gap-2 bg-white dark:bg-zinc-900">
                <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="w-full bg-zinc-100 dark:bg-zinc-900 p-3 rounded-2xl outline-none">
                <button id="chat-send" class="bg-blue-500 text-white px-6 rounded-2xl font-bold">‚Üë</button>
            </div>
        </section>

        <section id="view-notifs" class="view-section hidden">
            <h2 class="text-2xl font-black p-6">–°–æ–±—ã—Ç–∏—è</h2>
            <div id="notifs-list" class="divide-y dark:divide-zinc-900"></div>
        </section>

        <section id="view-profile" class="view-section hidden">
            <div class="p-6 border-b dark:border-zinc-800 bg-white dark:bg-zinc-900/50">
                <div class="flex justify-between items-start mb-4">
                    <img id="prof-av" src="" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500 shadow-xl">
                    <div class="flex gap-2">
                        <button id="msg-btn" class="hidden border dark:border-zinc-700 bg-white dark:bg-zinc-800 p-3 rounded-full">‚úâÔ∏è</button>
                        <button id="follow-btn" class="hidden bg-blue-500 text-white px-6 py-2 rounded-full font-bold text-sm">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                        <button id="edit-prof-btn" class="hidden border dark:border-zinc-700 bg-zinc-100 dark:bg-zinc-800 px-4 py-2 rounded-full text-sm font-bold">‚öôÔ∏è</button>
                    </div>
                </div>
                <h2 id="prof-nick" class="text-3xl font-black">–ò–º—è</h2>
                <p id="prof-user" class="text-blue-500 font-bold mb-4">@username</p>
                <div class="flex gap-8 border-t dark:border-zinc-800 pt-4">
                    <div class="text-center"><b id="count-subs" class="text-xl">0</b><p class="text-[10px] uppercase opacity-40 font-black">–ü–æ–¥–ø–∏—Å–∫–∏</p></div>
                    <div class="text-center"><b id="count-followers" class="text-xl">0</b><p class="text-[10px] uppercase opacity-40 font-black">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</p></div>
                </div>
            </div>
            <div id="prof-posts" class="divide-y dark:divide-zinc-900"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-zinc-950/90 backdrop-blur-xl border-t dark:border-zinc-800 flex justify-around p-4 z-50">
        <button onclick="showView('feed')" id="nav-feed" class="flex flex-col items-center opacity-40 text-2xl">üè†</button>
        <button onclick="showView('discovery')" id="nav-discovery" class="flex flex-col items-center opacity-40 text-2xl">üîç</button>
        <button onclick="showView('chats')" id="nav-chats" class="relative flex flex-col items-center opacity-40 text-2xl">üí¨<div id="dot-chats" class="notif-dot"></div></button>
        <button onclick="showView('notifs')" id="nav-notifs" class="relative flex flex-col items-center opacity-40 text-2xl">üîî<div id="dot-notifs" class="notif-dot"></div></button>
        <button onclick="openMyProfile()" id="nav-profile" class="flex flex-col items-center opacity-40 text-2xl">üë§</button>
    </nav>

    <div id="auth-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 p-10 rounded-[3rem] w-full max-w-sm shadow-2xl">
            <h2 id="auth-title" class="text-3xl font-black mb-8 text-center text-zinc-900 dark:text-white">–í—Ö–æ–¥</h2>
            <div id="reg-fields">
                <input type="text" id="reg-user" placeholder="@username" class="w-full p-4 mb-3 rounded-2xl bg-zinc-100 dark:bg-zinc-800 outline-none font-bold">
                <input type="text" id="reg-nick" placeholder="–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è" class="w-full p-4 mb-3 rounded-2xl bg-zinc-100 dark:bg-zinc-800 outline-none">
            </div>
            <input type="email" id="email" placeholder="Email" class="w-full p-4 mb-3 rounded-2xl bg-zinc-100 dark:bg-zinc-800 outline-none">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-4 mb-8 rounded-2xl bg-zinc-100 dark:bg-zinc-800 outline-none">
            <button id="submit-auth" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-bold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <p id="auth-toggle" class="mt-6 text-center text-sm font-bold text-blue-500 cursor-pointer underline">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>
    </div>

    <script>
        // --- –ó–ê–ú–ï–ù–ò –≠–¢–ò –î–ê–ù–ù–´–ï –ù–ê –°–í–û–ò –ò–ó FIREBASE CONSOLE ---
        const firebaseConfig = {
        apiKey: "AIzaSyALdLdIiC5Jwfkeo6gfa3OaHHm3gkQ3jtM",
        authDomain: "qiwi-8aa6a.firebaseapp.com",
        databaseURL: "https://qiwi-8aa6a-default-rtdb.firebaseio.com",
        projectId: "qiwi-8aa6a",
        storageBucket: "qiwi-8aa6a.firebasestorage.app",
        messagingSenderId: "1:12192651267:web:73e98c5c764a19e3d2d636",
        appId: "G-6HWP543LDE"
        }

        let currentUser = null, userProfile = null, allUsers = {}, isLogin = false, activeChatId = null, selectedImg = null;
        const vBadge = `<svg class="w-4 h-4 text-blue-500 inline ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293l-4 4a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L9 10.586l3.293-3.293a1 1 0 111.414 1.414z"></path></svg>`;

        window.showView = (view) => {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
            const nBtn = document.getElementById('nav-' + (view === 'chat-room' ? 'chats' : view));
            if(nBtn) nBtn.classList.add('active-nav');
            if(view === 'feed') renderFeed();
            if(view === 'discovery') renderUsers();
            if(view === 'chats') renderChatsList();
            if(view === 'notifs') markNotifsRead();
            window.scrollTo(0,0);
        };

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–î–ü–ò–°–ö–ò ---
        async function toggleFollow(targetUid) {
            if(!currentUser) return document.getElementById('auth-modal').classList.remove('hidden');
            if(currentUser.uid === targetUid) return;

            const myFollowingRef = db.ref(`following/${currentUser.uid}/${targetUid}`);
            const targetFollowersRef = db.ref(`followers/${targetUid}/${currentUser.uid}`);
            
            const snapshot = await myFollowingRef.once('value');
            if(snapshot.exists()) {
                await myFollowingRef.remove();
                await targetFollowersRef.remove();
            } else {
                await myFollowingRef.set(true);
                await targetFollowersRef.set(true);
                sendNotif(targetUid, "–ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ —Ç–µ–±—è ‚úÖ");
            }
            openProfile(targetUid); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è
        }

        window.openChat = (targetUid) => {
            if(!currentUser) return document.getElementById('auth-modal').classList.remove('hidden');
            const chatId = currentUser.uid < targetUid ? `${currentUser.uid}_${targetUid}` : `${targetUid}_${currentUser.uid}`;
            activeChatId = chatId;
            showView('chat-room');
            const target = allUsers[targetUid];
            document.getElementById('chat-target-nick').innerText = target.nickname;
            document.getElementById('chat-target-av').src = target.avatar || 'https://ui-avatars.com/api/?name='+target.nickname;
            db.ref(`messages/${chatId}`).off();
            db.ref(`messages/${chatId}`).on('value', s => {
                const box = document.getElementById('chat-messages'); box.innerHTML = "";
                if(s.val()) Object.values(s.val()).forEach(m => {
                    const isMe = m.sender === currentUser.uid;
                    box.innerHTML += `<div class="max-w-[80%] p-3 rounded-2xl text-sm ${isMe ? 'bg-blue-500 text-white self-end rounded-br-none' : 'bg-white dark:bg-zinc-800 self-start rounded-bl-none'}">${m.text}</div>`;
                });
                box.scrollTo(0, box.scrollHeight);
            });
        };

        document.getElementById('chat-send').onclick = () => {
            const t = document.getElementById('chat-input').value.trim();
            if(!t || !activeChatId) return;
            db.ref(`messages/${activeChatId}`).push({ sender: currentUser.uid, text: t, date: Date.now() });
            const targetUid = activeChatId.split('_').find(id => id !== currentUser.uid);
            sendNotif(targetUid, "–Ω–∞–ø–∏—Å–∞–ª(–∞) —Ç–µ–±–µ üí¨");
            document.getElementById('chat-input').value = "";
        };

        window.repost = async (postId) => {
            const s = await db.ref('posts/'+postId).once('value');
            const p = s.val(); if(!p) return;
            db.ref('posts').push({ uid: currentUser.uid, content: p.content, image: p.image || "", date: Date.now(), repost: { from: allUsers[p.uid]?.username || "user" } });
            sendNotif(p.uid, "—Å–¥–µ–ª–∞–ª(–∞) —Ä–µ–ø–æ—Å—Ç üîÑ");
            showView('feed');
        };

        window.deletePost = (id) => { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) db.ref('posts/'+id).remove(); };

        window.like = (id, tid) => {
            if(!currentUser) return;
            const r = db.ref(`posts/${id}/likes/${currentUser.uid}`);
            r.once('value').then(s => {
                if(!s.exists()) { r.set(true); sendNotif(tid, "–ª–∞–π–∫–Ω—É–ª(–∞) –ø–æ—Å—Ç ‚ù§Ô∏è"); }
                else r.remove();
            });
        };

        function drawPost(id, p) {
            const u = allUsers[p.uid] || {nickname: 'User', username: 'id'};
            const likes = p.likes ? Object.keys(p.likes).length : 0;
            const isLiked = p.likes && p.likes[currentUser?.uid];
            return `
                <div class="p-5 bg-white dark:bg-zinc-950 border-b dark:border-zinc-900">
                    <div class="flex gap-4">
                        <img onclick="openProfile('${p.uid}')" src="${u.avatar || 'https://ui-avatars.com/api/?name='+u.nickname}" class="w-12 h-12 rounded-full object-cover border dark:border-zinc-800">
                        <div class="w-full">
                            <div class="flex justify-between items-center mb-1">
                                <b onclick="openProfile('${p.uid}')" class="text-sm font-bold">@${u.username} ${u.isAdmin?vBadge:''}</b>
                                <div class="flex gap-2">
                                    ${userProfile?.isAdmin ? `<button onclick="deletePost('${id}')" class="text-[9px] text-red-500 font-bold uppercase">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                                    <span class="text-[9px] opacity-20 font-black">${new Date(p.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                </div>
                            </div>
                            <div class="${p.repost ? 'repost-border' : ''}">
                                ${p.repost ? `<p class="text-[10px] text-blue-500 font-black uppercase mb-1">–†–µ–ø–æ—Å—Ç –æ—Ç @${p.repost.from}</p>` : ''}
                                <p class="text-[16px] leading-relaxed">${p.content}</p>
                                ${p.image ? `<img src="${p.image}" class="mt-3 rounded-2xl w-full max-h-96 object-cover">` : ''}
                            </div>
                            <div class="flex gap-6 mt-4 items-center">
                                <button onclick="like('${id}', '${p.uid}')" class="flex items-center gap-1.5 text-xs font-black ${isLiked ? 'text-red-500' : 'opacity-20'}">${isLiked ? '‚ù§Ô∏è':'ü§ç'} ${likes}</button>
                                <button onclick="repost('${id}')" class="opacity-20 text-xs font-black">üîÑ –†–µ–ø–æ—Å—Ç</button>
                                <button onclick="openChat('${p.uid}')" class="opacity-20 text-xs font-black">üí¨ –ß–∞—Ç</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function sendNotif(tid, type) { if(tid && tid !== currentUser?.uid) db.ref(`notifications/${tid}`).push({ from: currentUser.uid, type, date: Date.now(), read: false }); }

        function markNotifsRead() {
            if(!currentUser) return;
            db.ref(`notifications/${currentUser.uid}`).once('value', s => {
                if(s.val()) Object.keys(s.val()).forEach(k => db.ref(`notifications/${currentUser.uid}/${k}`).update({read: true}));
                document.getElementById('dot-notifs').style.display = 'none';
            });
            renderNotifsList();
        }

        function renderNotifsList() {
            if(!currentUser) return;
            db.ref(`notifications/${currentUser.uid}`).limitToLast(30).on('value', s => {
                const list = document.getElementById('notifs-list'); list.innerHTML = "";
                if(s.val()) Object.values(s.val()).reverse().forEach(n => {
                    const u = allUsers[n.from] || {nickname: '–Æ–∑–µ—Ä', username: 'id'};
                    list.innerHTML += `<div class="p-4 flex items-center gap-3"><img src="${u.avatar || 'https://ui-avatars.com/api/?name='+u.nickname}" class="w-10 h-10 rounded-full"><p class="text-sm"><b>@${u.username}</b> ${n.type}</p></div>`;
                });
            });
        }

        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if(user) {
                document.getElementById('post-input').classList.remove('hidden');
                db.ref('users/' + user.uid).on('value', s => {
                    userProfile = s.val();
                    if(userProfile?.isAdmin) document.getElementById('admin-badge').classList.remove('hidden');
                });
                db.ref(`notifications/${user.uid}`).on('value', s => {
                    const hasNew = s.val() && Object.values(s.val()).some(n => !n.read);
                    document.getElementById('dot-notifs').style.display = hasNew ? 'block' : 'none';
                });
                document.getElementById('auth-btn').innerText = '–í—ã–π—Ç–∏';
            } else {
                document.getElementById('post-input').classList.add('hidden');
                document.getElementById('auth-btn').innerText = '–í–æ–π—Ç–∏';
            }
            renderFeed();
        });

        async function renderFeed() {
            const c = document.getElementById('feed-container'); c.innerHTML = "";
            const ps = await db.ref('posts').limitToLast(50).once('value');
            const posts = ps.val() ? Object.entries(ps.val()).reverse() : [];
            
            let subs = [];
            if(currentUser) {
                const fs = await db.ref(`following/${currentUser.uid}`).once('value');
                subs = fs.val() ? Object.keys(fs.val()) : [];
            }

            posts.forEach(([id, p]) => { 
                if(!currentUser || p.uid === currentUser.uid || subs.includes(p.uid)) {
                    c.innerHTML += drawPost(id, p); 
                }
            });
        }

        document.getElementById('search-input').oninput = (e) => {
            const q = e.target.value.toLowerCase().replace('@','');
            const list = document.getElementById('discovery-list'); list.innerHTML = "";
            Object.values(allUsers).forEach(u => {
                if(u.uid !== currentUser?.uid && (u.username.includes(q) || u.nickname.toLowerCase().includes(q))) {
                    list.innerHTML += `<div onclick="openProfile('${u.uid}')" class="flex items-center gap-3 bg-white dark:bg-zinc-900 p-4 rounded-2xl border dark:border-zinc-800"><img src="${u.avatar || 'https://ui-avatars.com/api/?name='+u.nickname}" class="w-12 h-12 rounded-full"><div><h4 class="font-bold">@${u.username}</h4><p class="text-xs opacity-50">${u.nickname}</p></div></div>`;
                }
            });
        };

        async function openProfile(uid) {
            showView('profile'); const user = allUsers[uid]; if(!user) return;
            document.getElementById('prof-nick').innerText = user.nickname;
            document.getElementById('prof-user').innerText = "@" + user.username;
            document.getElementById('prof-av').src = user.avatar || 'https://ui-avatars.com/api/?name=' + user.nickname;
            const fBtn = document.getElementById('follow-btn'), eBtn = document.getElementById('edit-prof-btn'), mBtn = document.getElementById('msg-btn');
            
            if(currentUser?.uid === uid) { 
                fBtn.classList.add('hidden'); mBtn.classList.add('hidden'); eBtn.classList.remove('hidden'); 
            } else { 
                fBtn.classList.remove('hidden'); mBtn.classList.remove('hidden'); eBtn.classList.add('hidden');
                const s = await db.ref(`following/${currentUser?.uid}/${uid}`).once('value');
                fBtn.innerText = s.exists() ? "–û—Ç–ø–∏—Å–∞—Ç—å—Å—è" : "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è";
                fBtn.className = s.exists() ? "border border-zinc-500 px-6 py-2 rounded-full font-bold text-sm" : "bg-blue-500 text-white px-6 py-2 rounded-full font-bold text-sm";
                fBtn.onclick = () => toggleFollow(uid); mBtn.onclick = () => openChat(uid);
            }

            db.ref(`following/${uid}`).on('value', s => document.getElementById('count-subs').innerText = s.numChildren());
            db.ref(`followers/${uid}`).on('value', s => document.getElementById('count-followers').innerText = s.numChildren());
            
            db.ref('posts').orderByChild('uid').equalTo(uid).once('value', s => {
                const cp = document.getElementById('prof-posts'); cp.innerHTML = "";
                if(s.val()) Object.entries(s.val()).reverse().forEach(([id, p]) => cp.innerHTML += drawPost(id, p));
            });
        }

        window.openMyProfile = () => currentUser ? openProfile(currentUser.uid) : document.getElementById('auth-modal').classList.remove('hidden');

        document.getElementById('submit-auth').onclick = async () => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            const u = document.getElementById('reg-user').value.toLowerCase().replace('@','').trim();
            const n = document.getElementById('reg-nick').value.trim();
            try {
                if(!isLogin) {
                    const ck = await db.ref('usernames/'+u).once('value');
                    if(ck.exists()) return alert("–ó–∞–Ω—è—Ç–æ");
                    const r = await auth.createUserWithEmailAndPassword(e, p);
                    await db.ref('users/'+r.user.uid).set({ uid: r.user.uid, username: u, nickname: n, avatar: "", isAdmin: false });
                    await db.ref('usernames/'+u).set(r.user.uid);
                } else await auth.signInWithEmailAndPassword(e, p);
                document.getElementById('auth-modal').classList.add('hidden');
            } catch(ex) { alert(ex.message); }
        };

        document.getElementById('send-btn').onclick = () => {
            const t = document.getElementById('post-text').value.trim();
            if(t || selectedImg) db.ref('posts').push({ uid: currentUser.uid, content: t, image: selectedImg, date: Date.now() });
            document.getElementById('post-text').value = ""; selectedImg = null;
        };

        document.getElementById('file-input').onchange = (e) => {
            const r = new FileReader(); r.onload = (ev) => selectedImg = ev.target.result; r.readAsDataURL(e.target.files[0]);
        };

        function renderChatsList() {
            if(!currentUser) return;
            const list = document.getElementById('chats-list'); list.innerHTML = "";
            db.ref(`following/${currentUser.uid}`).once('value', s => {
                Object.keys(s.val() || {}).forEach(uid => {
                    const u = allUsers[uid];
                    if(u) list.innerHTML += `<div onclick="openChat('${uid}')" class="p-5 flex items-center gap-4 border-b dark:border-zinc-900"><img src="${u.avatar || 'https://ui-avatars.com/api/?name='+u.nickname}" class="w-12 h-12 rounded-full"><b>@${u.username}</b></div>`;
                });
            });
        }

        document.getElementById('auth-btn').onclick = () => currentUser ? auth.signOut() : document.getElementById('auth-modal').classList.remove('hidden');
        document.getElementById('auth-toggle').onclick = () => { isLogin = !isLogin; document.getElementById('auth-title').innerText = isLogin ? "–í—Ö–æ–¥":"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"; document.getElementById('reg-fields').classList.toggle('hidden'); };
        
        db.ref('users').on('value', s => { allUsers = s.val() || {}; renderFeed(); });
        showView('feed');
    </script>
</body>
</html>