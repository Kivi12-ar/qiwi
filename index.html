<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Engine Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { padding-bottom: 90px; background-color: #09090b; color: #fafafa; font-family: system-ui, -apple-system, sans-serif; }
        .active-nav { color: #3b82f6 !important; opacity: 1 !important; transform: scale(1.1); }
        .view-section { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-primary { background-color: #3b82f6; color: white; transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.95); opacity: 0.8; }
        .post-card { border-bottom: 1px solid #18181b; transition: background 0.2s; }
        .post-card:hover { background-color: #0c0c0e; }
    </style>
</head>
<body>

    <header class="sticky top-0 z-40 bg-zinc-950/80 backdrop-blur-md border-b border-zinc-800 p-4 flex justify-between items-center">
        <h1 class="text-xl font-black text-blue-500 italic tracking-tighter cursor-pointer" onclick="showView('feed')">SOCIAL.</h1>
        <div class="flex items-center gap-3">
            <span id="admin-badge" class="hidden bg-red-500 text-[10px] text-white px-2 py-0.5 rounded-full font-bold uppercase">Admin</span>
            <button id="auth-btn" class="bg-blue-600 text-white px-4 py-1.5 rounded-full text-xs font-bold btn-primary">–í–æ–π—Ç–∏</button>
        </div>
    </header>

    <main class="max-w-2xl mx-auto min-h-screen">
        
        <section id="view-feed" class="view-section">
            <div id="post-input" class="p-4 border-b border-zinc-800 hidden bg-zinc-900/20">
                <textarea id="post-text" class="w-full bg-transparent text-lg outline-none resize-none placeholder-zinc-600" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" rows="2"></textarea>
                <div class="flex justify-between items-center mt-3">
                    <label class="p-2 text-blue-500 cursor-pointer hover:bg-blue-500/10 rounded-full transition">
                        üñºÔ∏è <input type="file" id="file-input" class="hidden" accept="image/*">
                    </label>
                    <button id="send-btn" class="btn-primary px-6 py-2 rounded-full font-bold text-sm">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                </div>
            </div>
            <div id="feed-container" class="divide-y divide-zinc-900">
                <div class="p-20 text-center opacity-20 italic">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>
            </div>
        </section>

        <section id="view-discovery" class="view-section hidden">
            <div class="p-4">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ @username –∏–ª–∏ –∏–º–µ–Ω–∏..." 
                       class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-blue-500 transition">
            </div>
            <div id="discovery-list" class="p-4 space-y-3"></div>
        </section>

        <section id="view-notifs" class="view-section hidden">
            <h2 class="text-2xl font-black p-6">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            <div id="notifs-list" class="divide-y divide-zinc-900"></div>
        </section>

        <section id="view-profile" class="view-section hidden">
            <div class="p-6 border-b border-zinc-800 bg-zinc-900/20">
                <div class="flex justify-between items-start mb-6">
                    <div class="relative">
                        <img id="prof-av" src="" class="w-24 h-24 rounded-full object-cover border-4 border-zinc-800 shadow-2xl bg-zinc-800">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button id="follow-btn" class="hidden btn-primary px-6 py-2 rounded-full font-bold text-sm">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                        <button id="edit-prof-btn" class="hidden border border-zinc-700 px-4 py-2 rounded-full text-xs font-bold hover:bg-zinc-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                </div>
                <h2 id="prof-nick" class="text-3xl font-black tracking-tight">–ò–º—è</h2>
                <p id="prof-user" class="text-blue-500 font-bold mb-6 text-lg">@username</p>
                
                <div class="flex gap-10 border-t border-zinc-800/50 pt-6">
                    <div class="text-center">
                        <b id="count-subs" class="text-xl block font-black text-white">0</b>
                        <span class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest">–ü–æ–¥–ø–∏—Å–∫–∏</span>
                    </div>
                    <div class="text-center">
                        <b id="count-followers" class="text-xl block font-black text-white">0</b>
                        <span class="text-[10px] uppercase text-zinc-500 font-bold tracking-widest">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</span>
                    </div>
                </div>
            </div>
            <div id="prof-posts" class="divide-y divide-zinc-900"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-zinc-950/90 backdrop-blur-xl border-t border-zinc-800 flex justify-around p-4 z-50">
        <button onclick="showView('feed')" id="nav-feed" class="active-nav flex flex-col items-center opacity-40 text-2xl transition-all">üè†</button>
        <button onclick="showView('discovery')" id="nav-discovery" class="flex flex-col items-center opacity-40 text-2xl transition-all">üîç</button>
        <button onclick="showView('notifs')" id="nav-notifs" class="relative flex flex-col items-center opacity-40 text-2xl transition-all">üîî<div id="dot-notifs" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></div></button>
        <button onclick="openMyProfile()" id="nav-profile" class="flex flex-col items-center opacity-40 text-2xl transition-all">üë§</button>
    </nav>

    <div id="auth-modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-[2.5rem] w-full max-w-sm shadow-2xl">
            <h2 id="auth-title" class="text-3xl font-black mb-8 text-center">–í—Ö–æ–¥</h2>
            <div id="reg-fields">
                <input type="text" id="reg-user" placeholder="@username" class="w-full p-4 mb-3 rounded-2xl bg-zinc-800 border border-zinc-700 outline-none focus:border-blue-500 font-bold">
                <input type="text" id="reg-nick" placeholder="–í–∞—à–µ –∏–º—è" class="w-full p-4 mb-3 rounded-2xl bg-zinc-800 border border-zinc-700 outline-none focus:border-blue-500">
            </div>
            <input type="email" id="email" placeholder="Email" class="w-full p-4 mb-3 rounded-2xl bg-zinc-800 border border-zinc-700 outline-none focus:border-blue-500">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-4 mb-8 rounded-2xl bg-zinc-800 border border-zinc-700 outline-none focus:border-blue-500">
            <button id="submit-auth" class="w-full btn-primary py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-blue-500/20">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <p id="auth-toggle" class="mt-6 text-center text-sm font-bold text-blue-500 cursor-pointer hover:underline">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì FIREBASE (–ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô) ---
        const firebaseConfig = {
        apiKey: "AIzaSyALdLdIiC5Jwfkeo6gfa3OaHHm3gkQ3jtM",
        authDomain: "qiwi-8aa6a.firebaseapp.com",
        databaseURL: "https://qiwi-8aa6a-default-rtdb.firebaseio.com",
        projectId: "qiwi-8aa6a",
        storageBucket: "qiwi-8aa6a.firebasestorage.app",
        messagingSenderId: "1:12192651267:web:73e98c5c764a19e3d2d636",
        appId: "G-6HWP543LDE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        let currentUser = null, userProfile = null, allUsers = {}, isLogin = true, selectedImg = null;

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function showView(view) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-40'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
            const activeBtn = document.getElementById('nav-' + view);
            if(activeBtn) {
                activeBtn.classList.add('active-nav');
                activeBtn.classList.remove('opacity-40');
            }
            if(view === 'feed') renderFeed();
            window.scrollTo(0,0);
        }

        // --- –õ–û–ì–ò–ö–ê –ü–û–î–ü–ò–°–ö–ò (–§–ò–ö–°) ---
        async function toggleFollow(targetUid) {
            if(!currentUser) return document.getElementById('auth-modal').classList.remove('hidden');
            if(currentUser.uid === targetUid) return;

            const myFollowPath = `following/${currentUser.uid}/${targetUid}`;
            const targetFollowerPath = `followers/${targetUid}/${currentUser.uid}`;
            
            const snap = await db.ref(myFollowPath).once('value');
            const updates = {};
            
            if(snap.exists()) {
                updates[myFollowPath] = null;
                updates[targetFollowerPath] = null;
            } else {
                updates[myFollowPath] = true;
                updates[targetFollowerPath] = true;
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                db.ref(`notifications/${targetUid}`).push({
                    from: currentUser.uid,
                    type: "–ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ —Ç–µ–±—è ‚úÖ",
                    date: Date.now()
                });
            }
            
            await db.ref().update(updates);
            openProfile(targetUid); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞
        function drawPost(id, p) {
            const u = allUsers[p.uid] || {nickname: 'User', username: 'id'};
            const likes = p.likes ? Object.keys(p.likes).length : 0;
            const isLiked = p.likes && currentUser && p.likes[currentUser.uid];
            
            return `
                <div class="p-5 post-card">
                    <div class="flex gap-4">
                        <img onclick="openProfile('${p.uid}')" src="${u.avatar || 'https://ui-avatars.com/api/?background=3f3f46&color=fff&name='+u.nickname}" class="w-12 h-12 rounded-full object-cover border border-zinc-800 bg-zinc-800 cursor-pointer">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <b onclick="openProfile('${p.uid}')" class="text-sm font-bold cursor-pointer hover:underline">@${u.username}</b>
                                <span class="text-[10px] opacity-30 font-bold">${new Date(p.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                            <p class="text-[15px] leading-relaxed text-zinc-200 whitespace-pre-wrap">${p.content}</p>
                            ${p.image ? `<img src="${p.image}" class="mt-3 rounded-2xl w-full max-h-96 object-cover border border-zinc-800 shadow-sm">` : ''}
                            <div class="flex gap-6 mt-4">
                                <button onclick="like('${id}', '${p.uid}')" class="flex items-center gap-2 text-xs font-black transition ${isLiked ? 'text-red-500' : 'text-zinc-500 hover:text-zinc-300'}">
                                    ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likes}
                                </button>
                                <button onclick="openProfile('${p.uid}')" class="text-xs font-black text-zinc-500 hover:text-zinc-300 transition">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // –†–µ–Ω–¥–µ—Ä –ª–µ–Ω—Ç—ã
        async function renderFeed() {
            const c = document.getElementById('feed-container');
            const snap = await db.ref('posts').limitToLast(50).once('value');
            c.innerHTML = "";
            const posts = snap.val() ? Object.entries(snap.val()).reverse() : [];
            
            if(posts.length === 0) {
                c.innerHTML = `<div class="p-20 text-center opacity-20 italic text-sm">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ...<br>–°—Ç–∞–Ω—å –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –ø–æ—Å—Ç!</div>`;
                return;
            }
            posts.forEach(([id, p]) => c.innerHTML += drawPost(id, p));
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        async function openProfile(uid) {
            showView('profile');
            const u = allUsers[uid];
            if(!u) return;
            
            document.getElementById('prof-nick').innerText = u.nickname;
            document.getElementById('prof-user').innerText = "@" + u.username;
            document.getElementById('prof-av').src = u.avatar || 'https://ui-avatars.com/api/?background=3b82f6&color=fff&size=128&name=' + u.nickname;
            
            const fBtn = document.getElementById('follow-btn');
            const eBtn = document.getElementById('edit-prof-btn');

            if(currentUser && currentUser.uid !== uid) {
                fBtn.classList.remove('hidden');
                eBtn.classList.add('hidden');
                const s = await db.ref(`following/${currentUser.uid}/${uid}`).once('value');
                fBtn.innerText = s.exists() ? "–û—Ç–ø–∏—Å–∞—Ç—å—Å—è" : "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è";
                fBtn.className = s.exists() ? "border border-zinc-700 px-6 py-2 rounded-full font-bold text-sm hover:bg-zinc-800" : "btn-primary px-6 py-2 rounded-full font-bold text-sm";
                fBtn.onclick = () => toggleFollow(uid);
            } else if(currentUser && currentUser.uid === uid) {
                fBtn.classList.add('hidden');
                eBtn.classList.remove('hidden');
            }

            db.ref(`following/${uid}`).on('value', s => document.getElementById('count-subs').innerText = s.numChildren());
            db.ref(`followers/${uid}`).on('value', s => document.getElementById('count-followers').innerText = s.numChildren());
            
            db.ref('posts').orderByChild('uid').equalTo(uid).once('value', s => {
                const cp = document.getElementById('prof-posts'); cp.innerHTML = "";
                if(s.val()) Object.entries(s.val()).reverse().forEach(([id, p]) => cp.innerHTML += drawPost(id, p));
            });
        }

        window.openMyProfile = () => currentUser ? openProfile(currentUser.uid) : document.getElementById('auth-modal').classList.remove('hidden');

        window.like = (id, tid) => {
            if(!currentUser) return document.getElementById('auth-modal').classList.remove('hidden');
            const r = db.ref(`posts/${id}/likes/${currentUser.uid}`);
            r.once('value').then(s => s.exists() ? r.remove() : r.set(true));
        };

        // Auth
        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('post-input').classList.toggle('hidden', !user);
            document.getElementById('auth-btn').innerText = user ? "–í—ã–π—Ç–∏" : "–í–æ–π—Ç–∏";
            if(user) {
                db.ref('users/' + user.uid).on('value', s => { 
                    userProfile = s.val(); 
                    if(userProfile?.isAdmin) document.getElementById('admin-badge').classList.remove('hidden');
                });
            }
            renderFeed();
        });

        document.getElementById('auth-btn').onclick = () => currentUser ? auth.signOut() : document.getElementById('auth-modal').classList.remove('hidden');
        
        document.getElementById('auth-toggle').onclick = () => { 
            isLogin = !isLogin; 
            document.getElementById('auth-title').innerText = isLogin ? "–í—Ö–æ–¥" : "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
            document.getElementById('reg-fields').classList.toggle('hidden', isLogin);
            document.getElementById('auth-toggle').innerText = isLogin ? "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç" : "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?";
        };

        document.getElementById('submit-auth').onclick = async () => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            const u = document.getElementById('reg-user').value.trim().toLowerCase().replace('@','');
            const n = document.getElementById('reg-nick').value.trim();
            try {
                if(!isLogin) {
                    if(!u || !n) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è");
                    const ck = await db.ref('usernames/'+u).once('value');
                    if(ck.exists()) return alert("Username –∑–∞–Ω—è—Ç");
                    const r = await auth.createUserWithEmailAndPassword(e, p);
                    await db.ref('users/'+r.user.uid).set({ uid: r.user.uid, username: u, nickname: n, avatar: "" });
                    await db.ref('usernames/'+u).set(r.user.uid);
                } else await auth.signInWithEmailAndPassword(e, p);
                document.getElementById('auth-modal').classList.add('hidden');
            } catch(ex) { alert(ex.message); }
        };

        document.getElementById('send-btn').onclick = () => {
            const t = document.getElementById('post-text').value.trim();
            if(!t && !selectedImg) return;
            db.ref('posts').push({ uid: currentUser.uid, content: t, image: selectedImg, date: Date.now() });
            document.getElementById('post-text').value = ""; selectedImg = null;
            renderFeed();
        };

        document.getElementById('file-input').onchange = (e) => {
            const r = new FileReader(); r.onload = (ev) => selectedImg = ev.target.result; r.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('search-input').oninput = (e) => {
            const q = e.target.value.toLowerCase();
            const list = document.getElementById('discovery-list'); list.innerHTML = "";
            Object.values(allUsers).forEach(u => {
                if(u.username.includes(q) || u.nickname.toLowerCase().includes(q)) {
                    list.innerHTML += `
                    <div onclick="openProfile('${u.uid}')" class="flex items-center gap-4 bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 hover:border-zinc-600 transition cursor-pointer">
                        <img src="${u.avatar || 'https://ui-avatars.com/api/?background=3f3f46&color=fff&name='+u.nickname}" class="w-12 h-12 rounded-full border border-zinc-800">
                        <div><b class="text-white">@${u.username}</b><p class="text-xs text-zinc-500">${u.nickname}</p></div>
                    </div>`;
                }
            });
        };

        // Realtime Listeners
        db.ref('users').on('value', s => { allUsers = s.val() || {}; });
        db.ref('posts').on('child_changed', renderFeed);
        db.ref('posts').on('child_added', renderFeed);

        // –ù–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
        showView('feed');
    </script>
</body>
</html>