<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicroBlog Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .post-img { max-height: 400px; width: 100%; object-fit: cover; border-radius: 1.5rem; margin-top: 12px; }
        .avatar-main { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; background: #3b82f6; flex-shrink: 0; }
        .repost-card { border: 1px solid rgba(59, 130, 246, 0.3); padding: 10px; margin-top: 10px; border-radius: 1rem; background: rgba(59, 130, 246, 0.03); }
        body { padding-bottom: 70px; } /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 transition-all">

    <div class="max-w-6xl mx-auto flex justify-center gap-6">
        <main class="w-full max-w-2xl bg-white dark:bg-zinc-800 min-h-screen shadow-2xl sm:border-x dark:border-zinc-700">
            
            <header class="p-4 border-b dark:border-zinc-700 sticky top-0 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-md z-40 flex justify-between items-center">
                <h1 class="text-2xl font-black text-blue-500 italic">M.</h1>
                <div class="flex items-center gap-3">
                    <button id="open-settings" class="hidden text-xs font-black uppercase text-blue-500">–ü—Ä–æ—Ñ–∏–ª—å ‚öôÔ∏è</button>
                    <img id="nav-avatar" src="" class="w-10 h-10 rounded-full border dark:border-zinc-700 hidden">
                    <button id="auth-btn" class="bg-blue-500 text-white px-4 py-2 rounded-full text-xs font-black uppercase shadow-lg">–í–æ–π—Ç–∏</button>
                </div>
            </header>

            <section id="view-feed">
                <div id="post-area" class="p-4 border-b dark:border-zinc-700 hidden">
                    <textarea id="post-text" class="w-full bg-transparent text-lg outline-none resize-none" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" rows="3"></textarea>
                    <div id="preview-box" class="hidden relative my-3">
                        <img id="img-preview" src="" class="rounded-2xl max-h-60 w-full object-cover">
                        <button onclick="clearImg()" class="absolute top-2 right-2 bg-black/60 text-white w-8 h-8 rounded-full">‚úï</button>
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t dark:border-zinc-700">
                        <label class="cursor-pointer text-blue-500 p-2">üñºÔ∏è <input type="file" id="file-input" class="hidden" accept="image/*"></label>
                        <button id="send-btn" class="bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-lg">–ü–æ—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
                <div id="feed" class="divide-y dark:divide-zinc-700"></div>
            </section>

            <section id="view-people" class="hidden p-4">
                <h2 class="text-xl font-black mb-4">–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ª—é–¥–∏</h2>
                <div id="rec-list-mobile" class="space-y-4"></div>
            </section>
        </main>

        <aside class="w-80 hidden lg:block py-6">
            <div class="bg-white dark:bg-zinc-800 p-6 rounded-[2rem] shadow-sm border dark:border-zinc-700 sticky top-24">
                <h3 class="font-black text-xs uppercase opacity-40 mb-5">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <div id="rec-list-desktop" class="space-y-5"></div>
            </div>
        </aside>
    </div>

    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-zinc-800/90 backdrop-blur-md border-t dark:border-zinc-700 flex justify-around p-3 z-50">
        <button onclick="switchTab('feed')" class="flex flex-col items-center gap-1">
            <span class="text-xl">üè†</span>
            <span class="text-[10px] font-bold uppercase">–õ–µ–Ω—Ç–∞</span>
        </button>
        <button onclick="switchTab('people')" class="flex flex-col items-center gap-1">
            <span class="text-xl">üë•</span>
            <span class="text-[10px] font-bold uppercase">–õ—é–¥–∏</span>
        </button>
        <button id="theme-toggle" class="flex flex-col items-center gap-1">
            <span class="text-xl">üåì</span>
            <span class="text-[10px] font-bold uppercase">–¢–µ–º–∞</span>
        </button>
    </nav>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-[2.5rem] w-full max-w-sm text-center">
            <div class="relative w-24 h-24 mx-auto mb-6">
                <img id="set-av-pre" src="" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500">
                <label class="absolute bottom-0 right-0 bg-blue-500 text-white p-2 rounded-full cursor-pointer">üì∑ <input type="file" id="av-input" class="hidden"></label>
            </div>
            <input type="text" id="new-nick" placeholder="–ù–∏–∫–Ω–µ–π–º" class="w-full p-4 rounded-2xl mb-4 bg-zinc-100 dark:bg-zinc-700 outline-none font-bold">
            <button id="save-set" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-bold shadow-xl">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="mt-4 text-xs opacity-40 font-bold uppercase tracking-widest">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="auth-modal" class="hidden fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-10 rounded-[3rem] w-full max-w-sm">
            <h2 id="auth-title" class="text-3xl font-black mb-8 text-center tracking-tighter">–í—Ö–æ–¥</h2>
            <div id="reg-box"><input type="text" id="reg-nick" placeholder="–¢–≤–æ–π –Ω–∏–∫" class="w-full p-4 mb-3 rounded-2xl bg-zinc-100 dark:bg-zinc-700 outline-none"></div>
            <input type="email" id="email" placeholder="Email" class="w-full p-4 mb-3 rounded-2xl bg-zinc-100 dark:bg-zinc-700 outline-none">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-4 mb-8 rounded-2xl bg-zinc-100 dark:bg-zinc-700 outline-none">
            <button id="submit-auth" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-bold text-lg shadow-2xl">–ü–æ–µ—Ö–∞–ª–∏</button>
            <p id="auth-toggle" class="mt-6 text-center text-sm font-bold text-blue-500 cursor-pointer italic">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</p>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG (–í—Å—Ç–∞–≤—å —Å–≤–æ–∏!) ---
        const firebaseConfig = {
        apiKey: "AIzaSyALdLdIiC5Jwfkeo6gfa3OaHHm3gkQ3jtM",
        authDomain: "qiwi-8aa6a.firebaseapp.com",
        databaseURL: "https://qiwi-8aa6a-default-rtdb.firebaseio.com",
        projectId: "qiwi-8aa6a",
        storageBucket: "qiwi-8aa6a.firebasestorage.app",
        messagingSenderId: "1:12192651267:web:73e98c5c764a19e3d2d636",
        appId: "G-6HWP543LDE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null, userProfile = null, allUsers = {}, selectedImg = null, isLogin = false;
        const vBadge = `<svg class="w-4 h-4 text-blue-500 inline ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293l-4 4a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L9 10.586l3.293-3.293a1 1 0 111.414 1.414z"></path></svg>`;

        // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–í–∞–∂–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∏–∫–æ–≤/–∞–≤) ---
        db.ref('users').on('value', s => {
            allUsers = s.val() || {};
            updateUI(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å—ë –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
        });

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if(user) {
                document.getElementById('post-area').classList.remove('hidden');
                db.ref('users/' + user.uid).on('value', s => {
                    userProfile = s.val();
                    document.getElementById('nav-avatar').src = userProfile?.avatar || `https://ui-avatars.com/api/?name=${userProfile?.nickname}`;
                    document.getElementById('nav-avatar').classList.remove('hidden');
                    document.getElementById('open-settings').classList.remove('hidden');
                    document.getElementById('auth-btn').innerText = '–í—ã—Ö–æ–¥';
                });
            } else {
                document.getElementById('post-area').classList.add('hidden');
                document.getElementById('nav-avatar').classList.add('hidden');
                document.getElementById('open-settings').classList.add('hidden');
                document.getElementById('auth-btn').innerText = '–í–æ–π—Ç–∏';
            }
        });

        // --- –§–£–ù–ö–¶–ò–ò –í–ö–õ–ê–î–û–ö ---
        window.switchTab = (tab) => {
            document.getElementById('view-feed').classList.toggle('hidden', tab !== 'feed');
            document.getElementById('view-people').classList.toggle('hidden', tab !== 'people');
            window.scrollTo(0, 0);
        };

        // --- –†–ï–ù–î–ï–† –ü–û–°–¢–ê (–°–ò–ù–•–†–û–ù–ù–´–ô) ---
        function renderPost(id, p) {
            const authorData = allUsers[p.uid] || { nickname: p.author, avatar: "" };
            const likes = p.likes ? Object.keys(p.likes).length : 0;
            const isLiked = p.likes && p.likes[currentUser?.uid];
            const av = authorData.avatar || `https://ui-avatars.com/api/?name=${authorData.nickname}`;
            
            return `
                <div class="p-5 hover:bg-zinc-50/50 dark:hover:bg-zinc-700/10 transition-colors">
                    <div class="flex gap-3">
                        <img src="${av}" class="avatar-main shadow-md">
                        <div class="w-full">
                            <div class="flex justify-between">
                                <span class="font-black text-sm">@${authorData.nickname} ${authorData.isAdmin ? vBadge : ''}</span>
                                <span class="text-[10px] opacity-30 font-bold uppercase">${new Date(p.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                            <p class="mt-2 text-[16px] leading-snug">${p.content}</p>
                            ${p.image ? `<img src="${p.image}" class="post-img shadow-xl">` : ''}
                            
                            ${p.repost ? `
                                <div class="repost-card">
                                    <div class="flex items-center gap-2 mb-1">
                                        <img src="${allUsers[p.repost.uid]?.avatar || 'https://ui-avatars.com/api/?name=' + p.repost.author}" class="w-5 h-5 rounded-full">
                                        <b class="text-xs">@${allUsers[p.repost.uid]?.nickname || p.repost.author}</b>
                                    </div>
                                    <p class="text-sm opacity-70 italic">${p.repost.content}</p>
                                </div>
                            ` : ''}

                            <div class="flex gap-8 mt-5 items-center">
                                <button onclick="doLike('${id}')" class="font-black text-xs flex items-center gap-1.5 ${isLiked ? 'text-red-500' : 'opacity-30'}">${isLiked ? '‚ù§Ô∏è':'ü§ç'} ${likes}</button>
                                <button onclick="toggleComm('${id}')" class="opacity-30 font-black text-xs">üí¨ ${p.comments ? Object.keys(p.comments).length : 0}</button>
                                <button onclick="doRepost('${id}')" class="opacity-30 text-xs">üîÅ</button>
                                ${userProfile?.isAdmin ? `<button onclick="delPost('${id}')" class="text-red-500 font-black text-[10px] ml-auto">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                            </div>
                            <div id="cbox-${id}" class="hidden mt-4 pt-4 border-t dark:border-zinc-700">
                                <div class="space-y-3 mb-4">
                                    ${p.comments ? Object.values(p.comments).map(c => {
                                        const cAuthor = allUsers[c.uid] || { nickname: c.author };
                                        return `<div class="text-sm"><b class="text-blue-500 text-xs">@${cAuthor.nickname}:</b> ${c.text}</div>`
                                    }).join('') : ''}
                                </div>
                                <div class="flex gap-2">
                                    <input id="cin-${id}" class="w-full bg-zinc-100 dark:bg-zinc-700 rounded-xl px-4 py-2 text-xs outline-none" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å...">
                                    <button onclick="addComm('${id}')" class="text-blue-500 font-bold px-2">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function updateUI() {
            db.ref('posts').once('value', s => {
                const f = document.getElementById('feed'); f.innerHTML = "";
                if(s.val()) Object.entries(s.val()).reverse().forEach(([id, p]) => f.innerHTML += renderPost(id, p));
            });
            
            // –°–ø–∏—Å–æ–∫ –ª—é–¥–µ–π
            const buildList = () => {
                let html = "";
                Object.values(allUsers).forEach(u => {
                    if(u.uid === currentUser?.uid) return;
                    const av = u.avatar || `https://ui-avatars.com/api/?name=${u.nickname}`;
                    html += `<div class="flex items-center gap-3"><img src="${av}" class="w-10 h-10 rounded-full border dark:border-zinc-700"><b class="text-sm">@${u.nickname} ${u.isAdmin ? vBadge : ''}</b></div>`;
                });
                document.getElementById('rec-list-desktop').innerHTML = html;
                document.getElementById('rec-list-mobile').innerHTML = html;
            }
            buildList();
        }

        // --- –î–ï–ô–°–¢–í–ò–Ø ---
        window.doRepost = (id) => {
            const myText = prompt("–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–µ–ø–æ—Å—Ç—É:", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!");
            if(myText === null) return;
            db.ref(`posts/${id}`).once('value', s => {
                db.ref('posts').push({
                    uid: currentUser.uid, author: userProfile.nickname,
                    content: myText, repost: s.val(), date: Date.now()
                });
            });
        };

        window.addComm = (id) => {
            const i = document.getElementById(`cin-${id}`); if(!i.value.trim()) return;
            db.ref(`posts/${id}/comments`).push({ uid: currentUser.uid, author: userProfile.nickname, text: i.value.trim() });
            i.value = "";
        };

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.doLike = id => { const r = db.ref(`posts/${id}/likes/${currentUser.uid}`); r.once('value').then(s => s.exists() ? r.remove() : r.set(true)); };
        window.toggleComm = id => document.getElementById(`cbox-${id}`).classList.toggle('hidden');
        window.delPost = id => confirm("–£–¥–∞–ª–∏—Ç—å?") && db.ref(`posts/${id}`).remove();

        document.getElementById('send-btn').onclick = () => {
            const t = document.getElementById('post-text').value.trim();
            if(!t && !selectedImg) return;
            db.ref('posts').push({ uid: currentUser.uid, author: userProfile.nickname, content: t, image: selectedImg, date: Date.now(), isAdmin: userProfile.isAdmin || false });
            document.getElementById('post-text').value = ""; clearImg();
        };

        // --- AUTH & SETTINGS ---
        document.getElementById('auth-btn').onclick = () => currentUser ? auth.signOut() : document.getElementById('auth-modal').classList.remove('hidden');
        document.getElementById('auth-toggle').onclick = () => { isLogin = !isLogin; document.getElementById('auth-title').innerText = isLogin ? "–í—Ö–æ–¥":"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"; document.getElementById('reg-box').style.display = isLogin ? "none":"block"; };
        document.getElementById('submit-auth').onclick = async () => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value, n = document.getElementById('reg-nick').value;
            try { if(isLogin) await auth.signInWithEmailAndPassword(e,p); else { const r = await auth.createUserWithEmailAndPassword(e,p); await db.ref('users/'+r.user.uid).set({ nickname: n, uid: r.user.uid, avatar: "" }); } document.getElementById('auth-modal').classList.add('hidden'); } catch(e) { alert(e.message); }
        };
        document.getElementById('open-settings').onclick = () => { document.getElementById('new-nick').value = userProfile.nickname; document.getElementById('set-av-pre').src = userProfile.avatar; document.getElementById('settings-modal').classList.remove('hidden'); };
        document.getElementById('save-set').onclick = async () => { await db.ref('users/'+currentUser.uid).update({ nickname: document.getElementById('new-nick').value, avatar: document.getElementById('set-av-pre').src }); document.getElementById('settings-modal').classList.add('hidden'); };
        
        // –§–∞–π–ª—ã
        document.getElementById('file-input').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { selectedImg = ev.target.result; document.getElementById('img-preview').src = selectedImg; document.getElementById('preview-box').classList.remove('hidden'); }; r.readAsDataURL(e.target.files[0]); };
        document.getElementById('av-input').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { document.getElementById('set-av-pre').src = ev.target.result; }; r.readAsDataURL(e.target.files[0]); };
        window.clearImg = () => { selectedImg = null; document.getElementById('preview-box').classList.add('hidden'); };
        document.getElementById('theme-toggle').onclick = () => document.documentElement.classList.toggle('dark');
        
        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        db.ref('posts').on('value', updateUI);
    </script>
</body>
</html>